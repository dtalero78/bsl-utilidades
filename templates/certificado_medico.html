<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificado Médico Ocupacional</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }

        .certificate-container {
            max-width: 8.5in;
            margin: 0 auto;
            background: white;
            padding: 40px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* === HEADER === */
        .header {
            display: grid;
            grid-template-columns: 200px 1fr 150px;
            gap: 20px;
            align-items: start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #00a651;
        }

        /* Logo section - Left */
        .logo-section {
            text-align: left;
        }

        .logo-section img {
            width: 180px;
            height: auto;
            margin-bottom: 10px;
        }

        .company-info {
            font-size: 9px;
            line-height: 1.4;
            color: #333;
        }

        /* Title section - Center */
        .title-section {
            text-align: center;
            padding-top: 10px;
        }

        .title-section h1 {
            color: #0066cc;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .security-code {
            font-size: 9px;
            color: #666;
            margin-bottom: 5px;
        }

        .exam-type {
            font-size: 11px;
            color: #333;
            font-weight: bold;
        }

        /* QR section - Right */
        .qr-section {
            text-align: center;
        }

        .qr-code {
            width: 120px;
            height: 120px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .qr-code img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .qr-verify-notice {
            margin-top: 5px;
            background: #0066cc;
            color: white;
            padding: 5px 8px;
            font-size: 8px;
            font-weight: bold;
            text-align: center;
            border-radius: 3px;
            text-transform: uppercase;
        }

        /* === DATOS PERSONALES SECTION === */
        .section {
            margin-bottom: 25px;
            position: relative;
        }

        .section-title {
            background: linear-gradient(90deg, #0066cc 0%, #00a651 100%);
            color: white;
            padding: 8px 15px;
            font-size: 13px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        /* Foto del paciente */
        .patient-photo {
            width: 90px;
            height: 110px;
            object-fit: cover;
            border: 2px solid #0066cc;
            background: #f9f9f9;
            border-radius: 5px;
        }

        /* Tabla de datos */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }

        .data-table td {
            padding: 6px 10px;
            border: 1px solid #ddd;
        }

        .data-table td.label {
            background: #f5f5f5;
            font-weight: bold;
            color: #0066cc;
            width: 18%;
        }

        .data-table td.value {
            background: white;
            color: #333;
        }

        /* Legal notice */
        .legal-notice {
            font-size: 8px;
            line-height: 1.4;
            color: #666;
            margin-top: 10px;
            padding: 8px;
            background: #f9f9f9;
            border-left: 3px solid #0066cc;
            font-style: italic;
        }

        /* === EXÁMENES REALIZADOS === */
        .exams-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .exam-box {
            background: #e8e8e8;
            padding: 12px;
            text-align: center;
            border-radius: 4px;
        }

        .exam-box h3 {
            font-size: 11px;
            color: #0066cc;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .exam-box .exam-date {
            font-size: 9px;
            color: #333;
        }

        /* === CONCEPTO MÉDICO === */
        .medical-concept {
            background: #f0f8ff;
            border: 2px solid #0066cc;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .medical-concept .result {
            color: #00a651;
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .medical-concept .description {
            font-size: 10px;
            line-height: 1.5;
            text-align: justify;
            color: #333;
        }

        /* === AVISO SIN SOPORTE === */
        .sin-soporte {
            background: #ffe6e6;
            border: 4px solid #dc3545;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }

        .sin-soporte .warning-text {
            color: #c82333;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            line-height: 1.8;
        }

        .hidden {
            display: none;
        }

        /* === RESULTADOS GENERALES === */
        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #0066cc;
        }

        .result-item h3 {
            color: #0066cc;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .result-item p {
            font-size: 10px;
            line-height: 1.6;
            text-align: justify;
            color: #333;
        }

        /* === ANÁLISIS POSTURAL === */
        .postural-box {
            margin-bottom: 20px;
            padding: 15px;
            background: #f0f8ff;
            border: 2px solid #0066cc;
            border-radius: 8px;
        }

        .postural-box h4 {
            color: #0066cc;
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 12px;
            text-align: center;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 8px;
        }

        .postural-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .postural-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #0066cc;
        }

        .postural-item strong {
            color: #0066cc;
            font-size: 9px;
            display: block;
            margin-bottom: 4px;
        }

        .postural-item span {
            color: #333;
            font-size: 10px;
            font-weight: bold;
        }

        /* === FIRMAS === */
        .signatures-section {
            margin-top: 30px;
            margin-bottom: 20px;
        }

        .signatures-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            background: #ffffff;
            padding: 20px;
            border: 1px solid #ccc;
        }

        .signature-box {
            text-align: center;
        }

        .signature-box .signature-header {
            background: #d0d0d0;
            padding: 8px;
            font-size: 11px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .signature-box .signature-line {
            min-height: 60px;
            text-align: center;
            margin-bottom: 10px;
        }

        .signature-box .signature-name {
            font-size: 11px;
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .signature-box .signature-details {
            font-size: 9px;
            color: #666;
            line-height: 1.3;
        }

        /* === FIRMAS === */
        .signature-img {
            width: 150px;
            height: 50px;
            margin: 0 auto;
            object-fit: contain;
        }

        /* === FOOTER === */
        .footer {
            background: #e8f4fd;
            padding: 12px;
            text-align: center;
            font-size: 9px;
            color: #333;
            margin-top: 20px;
            border: 1px solid #ccc;
        }

        /* === CONTROLES DE SALTO DE PÁGINA === */
        @media print {
            /* Evitar que las secciones se dividan entre páginas */
            .section {
                page-break-inside: avoid;
            }

            /* Evitar que la cabecera se divida */
            .header {
                page-break-inside: avoid;
                page-break-after: avoid;
            }

            /* Evitar que las tablas se dividan */
            .data-table {
                page-break-inside: avoid;
            }

            /* Evitar que los items de resultado se dividan */
            .result-item {
                page-break-inside: avoid;
            }

            /* Evitar que el análisis postural se divida */
            .postural-box {
                page-break-inside: avoid;
            }

            /* Evitar que el concepto médico se divida */
            .medical-concept {
                page-break-inside: avoid;
            }

            /* Evitar que las firmas se dividan */
            .signatures-section {
                page-break-inside: avoid;
            }

            /* Permitir saltos de página automáticos antes de secciones cuando sea necesario */
            .section {
                page-break-before: auto;
            }

            /* El footer siempre al final */
            .footer {
                page-break-inside: avoid;
            }

            /* ADC tables should not break */
            .adc-table {
                page-break-inside: avoid;
            }
        }

        /* === PERFIL PSICOLÓGICO ADC === */
        .adc-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            margin-bottom: 15px;
        }

        .adc-table th {
            background: #0066cc;
            color: white;
            padding: 6px 8px;
            text-align: center;
            font-size: 9px;
            font-weight: bold;
        }

        .adc-table td {
            padding: 5px 8px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 10px;
        }

        .adc-table tr:nth-child(even) td {
            background: #f9f9f9;
        }

        .adc-table .row-general td {
            background: #e8f4fd;
            font-weight: bold;
        }

        .nivel-muy-bajo { color: #c62828; font-weight: bold; }
        .nivel-bajo { color: #f44336; font-weight: bold; }
        .nivel-medio-bajo { color: #ff9800; font-weight: bold; }
        .nivel-medio { color: #ffc107; font-weight: bold; }
        .nivel-medio-alto { color: #8bc34a; font-weight: bold; }
        .nivel-alto { color: #5cb85c; font-weight: bold; }
        .nivel-muy-alto { color: #28a745; font-weight: bold; }

        .adc-subsection {
            margin-bottom: 20px;
        }

        .adc-subsection-title {
            font-size: 12px;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 8px;
            padding: 6px 10px;
            background: #e8f4fd;
            border-left: 4px solid #0066cc;
        }

        .adc-interpretacion {
            font-size: 10px;
            line-height: 1.5;
            color: #333;
            padding: 8px 10px;
            background: #f9f9f9;
            border-left: 3px solid #8bc34a;
            margin-top: 8px;
            text-align: justify;
        }
    </style>
</head>
<body>
    <div class="certificate-container">
        <!-- HEADER -->
        <div class="header">
            <!-- Logo izquierdo -->
            <div class="logo-section">
                <img src="{{ logo_url }}" alt="BSL Logo">
                <div class="company-info">
                    Nit. 900.844.030-8<br>
                    Licencia No. 64 del 10-01-2017<br>
                    Calle 134 # 7-83 cons 233, Bogotá D.C.<br>
                    www.bsl.com.co
                </div>
            </div>

            <!-- Título central -->
            <div class="title-section">
                <h1>Certificado Médico Ocupacional</h1>
                <div class="security-code">Código de Seguridad: {{ codigo_seguridad }}</div>
                <div class="exam-type">Tipo Examen: {{ tipo_examen }}</div>
            </div>

            <!-- QR derecho -->
            <div class="qr-section">
                <div class="qr-code">
                    <img src="https://bsl-utilidades-yp78a.ondigitalocean.app/images/qr-validacion.jpg" alt="QR Code">
                </div>
                <div class="qr-verify-notice">
                    Verifica validez del certificado
                </div>
            </div>
        </div>

        <!-- DATOS PERSONALES -->
        <div class="section">
            <div class="section-title">Datos Personales</div>

            <div style="display: flex; gap: 15px; align-items: flex-start;">
                <!-- Foto del paciente (si existe) -->
                {% if foto_paciente %}
                <div style="flex-shrink: 0;">
                    <img src="{{ foto_paciente }}" alt="Foto paciente" class="patient-photo">
                </div>
                {% endif %}

                <div style="flex: 1;">
                    <table class="data-table">
                <tr>
                    <td class="label">Fecha de Atención</td>
                    <td class="value">{{ fecha_atencion }}</td>
                    <td class="label">Ciudad</td>
                    <td class="value">{{ ciudad }}</td>
                    <td class="label">Vigencia</td>
                    <td class="value">{{ vigencia }}</td>
                </tr>
                <tr>
                    <td class="label">IPS/SEDE</td>
                    <td class="value" colspan="5">{{ ips_sede }}</td>
                </tr>
                <tr>
                    <td class="label">Nombres y apellidos</td>
                    <td class="value" colspan="5">{{ nombres_apellidos }}</td>
                </tr>
                <tr>
                    <td class="label">Documento identidad</td>
                    <td class="value">{{ documento_identidad }}</td>
                    <td class="label">Empresa o entidad</td>
                    <td class="value">{{ empresa }}</td>
                    <td class="label">Cargo</td>
                    <td class="value">{{ cargo }}</td>
                </tr>
                <tr>
                    <td class="label">Género</td>
                    <td class="value">{{ genero }}</td>
                    <td class="label">Edad</td>
                    <td class="value">{{ edad }}</td>
                    <td class="label">Fecha nacimiento</td>
                    <td class="value">{{ fecha_nacimiento }}</td>
                </tr>
                <tr>
                    <td class="label">Estado civil</td>
                    <td class="value">{{ estado_civil }}</td>
                    <td class="label">Hijos</td>
                    <td class="value">{{ hijos }}</td>
                    <td class="label">Profesión u Oficio</td>
                    <td class="value">{{ profesion }}</td>
                </tr>
                <tr>
                    <td class="label">Email</td>
                    <td class="value" colspan="5">{{ email }}</td>
                </tr>
                <tr>
                    <td class="label">Teléfono</td>
                    <td class="value" colspan="5">{{ celular }}</td>
                </tr>
                <tr>
                    <td class="label">Tipo de examen</td>
                    <td class="value">{{ tipo_examen }}</td>
                    <td class="label">EPS</td>
                    <td class="value">{{ eps }}</td>
                    <td class="label">ARL</td>
                    <td class="value">{{ arl }}</td>
                </tr>
                <tr>
                    <td class="label">Pensiones</td>
                    <td class="value">{{ pensiones }}</td>
                    <td class="label">Nivel Educativo</td>
                    <td class="value" colspan="3">{{ nivel_educativo }}</td>
                </tr>
                    </table>
                </div>
            </div>

            <div class="legal-notice">
                * De conformidad con la Ley de Protección de Datos Personales, informamos que la información contenida en este certificado médico es confidencial y será utilizada exclusivamente para los fines relacionados con la evaluación de la aptitud laboral del trabajador. El tratamiento de los datos personales se llevará a cabo conforme a la normativa vigente, garantizando su integridad, confidencialidad y seguridad, y no serán compartidos con terceros sin el consentimiento expreso del titular, salvo por mandato legal o judicial.
            </div>
        </div>

        <!-- EXÁMENES REALIZADOS -->
        <div class="section">
            <div class="section-title">Exámenes Realizados</div>
            <div class="exams-container">
                {% for examen in examenes_realizados %}
                <div class="exam-box">
                    <h3>{{ examen.nombre }}</h3>
                    <div class="exam-date">{{ examen.fecha }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- AVISO SIN SOPORTE DE PAGO -->
        {% if mostrar_sin_soporte %}
        <div class="section">
            <div class="sin-soporte">
                <div class="warning-text">
                    {{ texto_sin_soporte }}
                </div>
            </div>
        </div>
        {% else %}
        <!-- CONCEPTO DE EVALUACIÓN MÉDICA (solo si existe concepto_medico) -->
        {% if concepto_medico %}
        <div class="section">
            <div class="section-title">Concepto de Evaluación Médica</div>
            <div class="medical-concept">
                <div class="result">{{ concepto_medico }}</div>
                <div class="description">
                    De acuerdo al examen ocupacional realizado a {{ nombres_apellidos }} con documento de identificación No {{ documento_identidad }} se considera que es {{ concepto_medico }} para desempeñar la ocupación del cargo descrito
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}

        <!-- RESULTADOS GENERALES -->
        {% if not mostrar_sin_soporte %}
        <div class="section">
            <div class="section-title">Resultados Generales</div>
            {% for resultado in resultados_generales %}
            <div class="result-item">
                <h3>{{ resultado.examen }}</h3>
                <p>{{ resultado.descripcion }}</p>
            </div>
            {% endfor %}
        </div>

        <!-- ANÁLISIS POSTURAL -->
        {% if analisis_postural and analisis_postural|length > 0 %}
        <div class="section">
            <div class="section-title">Análisis Postural</div>
            {% for ejercicio in analisis_postural %}
            <div class="postural-box">
                <h4>EJERCICIO {{ ejercicio.numero }} - {{ ejercicio.hora }}</h4>

                <div class="postural-data">
                    <!-- Postura -->
                    <div class="postural-item">
                        <strong>Ángulo del tronco:</strong>
                        <span>{{ ejercicio.angulo_tronco }}°</span>
                    </div>
                    <div class="postural-item">
                        <strong>Alineación:</strong>
                        <span>{{ ejercicio.alineacion }}</span>
                    </div>

                    <!-- Ángulos articulares -->
                    <div class="postural-item">
                        <strong>Codo izquierdo:</strong>
                        <span>{{ ejercicio.angulos.codo_izq }}°</span>
                    </div>
                    <div class="postural-item">
                        <strong>Codo derecho:</strong>
                        <span>{{ ejercicio.angulos.codo_der }}°</span>
                    </div>
                    <div class="postural-item">
                        <strong>Rodilla izquierda:</strong>
                        <span>{{ ejercicio.angulos.rodilla_izq }}°</span>
                    </div>
                    <div class="postural-item">
                        <strong>Rodilla derecha:</strong>
                        <span>{{ ejercicio.angulos.rodilla_der }}°</span>
                    </div>

                    <!-- Simetría corporal -->
                    <div class="postural-item">
                        <strong>Simetría de hombros:</strong>
                        <span>{{ ejercicio.simetria.hombros }} ({{ ejercicio.simetria.hombros_diff }}%)</span>
                    </div>
                    <div class="postural-item">
                        <strong>Simetría de caderas:</strong>
                        <span>{{ ejercicio.simetria.caderas }} ({{ ejercicio.simetria.caderas_diff }}%)</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- RECOMENDACIONES MÉDICAS ADICIONALES -->
        {% if recomendaciones_medicas %}
        <div class="section" style="margin-top: 30px;">
            <div class="section-title">Recomendaciones Médicas Adicionales</div>
            <div class="result-item">
                <p style="white-space: pre-line;">{{ recomendaciones_medicas }}</p>
            </div>
        </div>
        {% endif %}

        <!-- FIRMAS -->
        {% if not mostrar_sin_soporte %}
        <div class="signatures-section">
            <div class="section-title">Firmas</div>
            <div class="signatures-container" style="grid-template-columns: repeat(2, 1fr);">
                <!-- Firma Médico -->
                <div class="signature-box">
                    <div class="signature-header">Firma Médico</div>
                    <div class="signature-line">
                        {% if firma_medico_url %}
                        <img src="{{ firma_medico_url }}" alt="Firma Médico" class="signature-img">
                        {% endif %}
                    </div>
                    <div class="signature-name">{{ medico_nombre }}</div>
                    <div class="signature-details">
                        {{ medico_registro }}<br>
                        {{ medico_licencia }}<br>
                        {{ medico_fecha }}
                    </div>
                </div>

                <!-- Firma Paciente -->
                <div class="signature-box">
                    <div class="signature-header">Firma Paciente Atendido</div>
                    <div class="signature-line">
                        {% if firma_paciente_url %}
                        <img src="{{ firma_paciente_url }}" alt="Firma Paciente" class="signature-img">
                        {% endif %}
                    </div>
                    <div class="signature-name">{{ nombres_apellidos }}</div>
                    <div class="signature-details">
                        {{ documento_identidad }}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- RESULTADOS DE PRUEBA VISUAL (Optometría o Visiometría) -->
        {% if 'Optometría' in examenes or 'OPTOMETRÍA' in examenes or 'Visiometría' in examenes or 'VISIOMETRÍA' in examenes %}
        <div class="section" style="margin-top: 30px;">
            <div class="section-title">
                {% if 'Optometría' in examenes or 'OPTOMETRÍA' in examenes %}
                Resultados de Optometría
                {% else %}
                Resultados de Visiometría
                {% endif %}
            </div>

            {% if datos_visual %}
                <div class="result-item">
                    <h3>Resultados Numéricos</h3>
                    <p style="font-family: 'Courier New', monospace; white-space: pre-line;">{{ datos_visual.resultadoNumerico }}</p>
                </div>

                {% if datos_visual.miopia %}
                <div class="result-item">
                    <h3>Miopía</h3>
                    <p>{{ datos_visual.miopia }}</p>
                </div>
                {% endif %}

                {% if datos_visual.astigmatismo %}
                <div class="result-item">
                    <h3>Astigmatismo</h3>
                    <p>{{ datos_visual.astigmatismo }}</p>
                </div>
                {% endif %}

                <div class="result-item">
                    <h3>Evaluación General</h3>
                    <p>Presión intraocular (PIO): 15 mmHg en ambos ojos<br>
                    Reflejos pupilares: Respuesta pupilar normal a la luz en ambos ojos<br>
                    Campo visual: Normal en ambos ojos<br>
                    Visión de colores: Normal<br>
                    Fondo de ojo: Normal.</p>
                </div>

                <!-- Firma del Optómetra -->
                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; align-items: end;">
                        <div style="text-align: center;">
                            <div style="padding-bottom: 5px; margin-bottom: 5px; min-height: 50px; display: flex; align-items: center; justify-content: center;">
                                {% if firma_optometra_url %}
                                <img src="{{ firma_optometra_url }}" alt="Firma Optómetra" class="signature-img">
                                {% else %}
                                &nbsp;
                                {% endif %}
                            </div>
                            <div style="border-top: 1px solid #333; padding-top: 5px;">
                                <p style="font-size: 10px; margin: 0; font-weight: bold;">{{ optometra_nombre }}</p>
                                <p style="font-size: 9px; margin: 0; color: #666;">{{ optometra_registro }}</p>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <p style="font-size: 9px; margin: 0; color: #666;">Fecha: {{ fecha_atencion }}</p>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="result-item" style="text-align: center; padding: 40px; background: #fff3cd; border-left: 4px solid #ffc107;">
                    <h3 style="color: #856404;">NO HAY DATOS DISPONIBLES</h3>
                    <p style="color: #856404;">No se encontraron resultados de la prueba visual para este paciente.</p>
                </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- RESULTADOS DE AUDIOMETRÍA -->
        {% if 'Audiometría' in examenes or 'AUDIOMETRÍA' in examenes %}
        <div class="section" style="margin-top: 30px;">
            <div class="section-title">Resultados de Audiometría</div>

            {% if datos_audiometria %}
            <!-- Audiograma SVG -->
            <div style="background: white; padding: 20px; border: 1px solid #ddd; margin-bottom: 20px;">
                <svg width="100%" height="400" viewBox="0 0 700 400" xmlns="http://www.w3.org/2000/svg">
                    <!-- Fondo y grid -->
                    <rect width="700" height="400" fill="#f9f9f9"/>

                    <!-- Título -->
                    <text x="350" y="25" text-anchor="middle" font-size="16" font-weight="bold" fill="#333">AUDIOGRAMA</text>

                    <!-- Leyendas -->
                    <g transform="translate(500, 40)">
                        <circle cx="0" cy="0" r="4" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/>
                        <text x="10" y="5" font-size="12" fill="#333">Oído Derecho</text>

                        <circle cx="0" cy="20" r="4" fill="#3498db" stroke="#2980b9" stroke-width="2"/>
                        <text x="10" y="25" font-size="12" fill="#333">Oído Izquierdo</text>
                    </g>

                    <!-- Ejes y grid del audiograma (simplificado) -->
                    <g transform="translate(80, 70)">
                        <!-- Solo líneas principales cada 25 dB -->
                        {% for db in range(0, 100, 25) %}
                        <line x1="0" y1="{{ (db + 10) * 2.5 }}" x2="540" y2="{{ (db + 10) * 2.5 }}"
                              stroke="#ddd" stroke-width="1" opacity="0.5"/>
                        <text x="-10" y="{{ (db + 10) * 2.5 + 4 }}" text-anchor="end" font-size="10" fill="#666">{{ db }}</text>
                        {% endfor %}

                        <!-- Solo ejes de frecuencias (sin grid vertical) -->
                        {% set frecuencias = [125, 250, 500, 1000, 2000, 3000, 4000, 6000, 8000] %}
                        {% for i in range(9) %}
                        <text x="{{ i * 60 }}" y="370" text-anchor="middle" font-size="10" fill="#666">{{ frecuencias[i] }}</text>
                        {% endfor %}

                        <!-- Borde del gráfico -->
                        <rect x="0" y="0" width="540" height="350" fill="none" stroke="#999" stroke-width="1.5"/>

                        <!-- Etiqueta eje Y -->
                        <text x="-50" y="175" text-anchor="middle" font-size="12" font-weight="bold" fill="#333" transform="rotate(-90, -50, 175)">
                            DECIBELES (dB)
                        </text>

                        <!-- Etiqueta eje X -->
                        <text x="270" y="395" text-anchor="middle" font-size="12" font-weight="bold" fill="#333">
                            FRECUENCIA (Hz)
                        </text>

                        <!-- Zona de audición normal (sombreado) -->
                        <rect x="0" y="0" width="540" height="62.5" fill="#c8e6c9" opacity="0.3"/>
                        <text x="270" y="35" text-anchor="middle" font-size="10" fill="#2e7d32" font-style="italic">
                            Audición Normal (0-25 dB)
                        </text>

                        <!-- Datos del audiograma -->
                        {% if datos_audiometria.datosParaTabla %}
                            <!-- Línea Oído Derecho -->
                            <polyline points="
                                {% for dato in datos_audiometria.datosParaTabla %}
                                    {% set freq_index = [250, 500, 1000, 2000, 3000, 4000, 6000, 8000].index(dato.frecuencia) if dato.frecuencia in [250, 500, 1000, 2000, 3000, 4000, 6000, 8000] else 0 %}
                                    {% set x = freq_index * 60 + 60 %}
                                    {% set y = (dato.oidoDerecho + 10) * 2.5 %}
                                    {{ x }},{{ y }}{% if not loop.last %} {% endif %}
                                {% endfor %}
                            " fill="none" stroke="#e74c3c" stroke-width="2"/>

                            <!-- Puntos Oído Derecho -->
                            {% for dato in datos_audiometria.datosParaTabla %}
                                {% set freq_index = [250, 500, 1000, 2000, 3000, 4000, 6000, 8000].index(dato.frecuencia) if dato.frecuencia in [250, 500, 1000, 2000, 3000, 4000, 6000, 8000] else 0 %}
                                {% set x = freq_index * 60 + 60 %}
                                {% set y = (dato.oidoDerecho + 10) * 2.5 %}
                                <circle cx="{{ x }}" cy="{{ y }}" r="4" fill="#e74c3c" stroke="#c0392b" stroke-width="2"/>
                            {% endfor %}

                            <!-- Línea Oído Izquierdo -->
                            <polyline points="
                                {% for dato in datos_audiometria.datosParaTabla %}
                                    {% set freq_index = [250, 500, 1000, 2000, 3000, 4000, 6000, 8000].index(dato.frecuencia) if dato.frecuencia in [250, 500, 1000, 2000, 3000, 4000, 6000, 8000] else 0 %}
                                    {% set x = freq_index * 60 + 60 %}
                                    {% set y = (dato.oidoIzquierdo + 10) * 2.5 %}
                                    {{ x }},{{ y }}{% if not loop.last %} {% endif %}
                                {% endfor %}
                            " fill="none" stroke="#3498db" stroke-width="2"/>

                            <!-- Puntos Oído Izquierdo -->
                            {% for dato in datos_audiometria.datosParaTabla %}
                                {% set freq_index = [250, 500, 1000, 2000, 3000, 4000, 6000, 8000].index(dato.frecuencia) if dato.frecuencia in [250, 500, 1000, 2000, 3000, 4000, 6000, 8000] else 0 %}
                                {% set x = freq_index * 60 + 60 %}
                                {% set y = (dato.oidoIzquierdo + 10) * 2.5 %}
                                <circle cx="{{ x }}" cy="{{ y }}" r="4" fill="#3498db" stroke="#2980b9" stroke-width="2"/>
                            {% endfor %}
                        {% endif %}
                    </g>
                </svg>
            </div>

            <!-- Diagnóstico -->
            {% if datos_audiometria.diagnostico %}
            <div class="result-item">
                <h3>Diagnóstico</h3>
                <p>{{ datos_audiometria.diagnostico }}</p>
            </div>
            {% endif %}
            {% else %}
                <div class="result-item" style="text-align: center; padding: 40px; background: #fff3cd; border-left: 4px solid #ffc107;">
                    <h3 style="color: #856404;">NO HAY DATOS DISPONIBLES</h3>
                    <p style="color: #856404;">No se encontraron resultados de audiometría para este paciente.</p>
                </div>
            {% endif %}
        </div>
        {% endif %}
        {% endif %}

        <!-- RESULTADOS DE PERFIL PSICOLÓGICO ADC -->
        {% if 'PERFIL PSICOLÓGICO ADC' in examenes or 'Perfil Psicológico ADC' in examenes or 'PERFIL PSICOLOGICO ADC' in examenes %}
        <div class="section" style="page-break-before: always; margin-top: 30px;">
            <div class="section-title">Resultados del Perfil Psicológico ADC</div>

            {% if datos_adc %}

            <!-- ANSIEDAD -->
            <div class="adc-subsection">
                <div class="adc-subsection-title">Escala de Ansiedad</div>
                <table class="adc-table">
                    <thead>
                        <tr>
                            <th>Subdimensión</th>
                            <th>Puntaje Bruto</th>
                            <th>Puntaje Estandarizado</th>
                            <th>Nivel</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for nombre, datos in datos_adc.ansiedad.subdimensiones.items() %}
                        <tr>
                            <td style="text-align: left; font-weight: bold;">{{ nombre }}</td>
                            <td>{{ datos.raw }}</td>
                            <td>{{ datos.estandarizado }}</td>
                            <td class="nivel-{{ datos.nivel|lower|replace(' ', '-') }}">{{ datos.nivel }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="row-general">
                            <td style="text-align: left;">GENERAL</td>
                            <td>{{ datos_adc.ansiedad.general.raw }}</td>
                            <td>{{ datos_adc.ansiedad.general.estandarizado }}</td>
                            <td class="nivel-{{ datos_adc.ansiedad.general.nivel|lower|replace(' ', '-') }}">{{ datos_adc.ansiedad.general.nivel }}</td>
                        </tr>
                    </tbody>
                </table>
                {% if datos_adc.ansiedad.general.interpretacion %}
                <div class="adc-interpretacion">
                    <strong>Interpretación General:</strong> {{ datos_adc.ansiedad.general.interpretacion }}
                </div>
                {% endif %}
            </div>

            <!-- DEPRESIÓN -->
            <div class="adc-subsection">
                <div class="adc-subsection-title">Escala de Depresión</div>
                <table class="adc-table">
                    <thead>
                        <tr>
                            <th>Subdimensión</th>
                            <th>Puntaje Bruto</th>
                            <th>Puntaje Estandarizado</th>
                            <th>Nivel</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for nombre, datos in datos_adc.depresion.subdimensiones.items() %}
                        <tr>
                            <td style="text-align: left; font-weight: bold;">{{ nombre }}</td>
                            <td>{{ datos.raw }}</td>
                            <td>{{ datos.estandarizado }}</td>
                            <td class="nivel-{{ datos.nivel|lower|replace(' ', '-') }}">{{ datos.nivel }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="row-general">
                            <td style="text-align: left;">GENERAL</td>
                            <td>{{ datos_adc.depresion.general.raw }}</td>
                            <td>{{ datos_adc.depresion.general.estandarizado }}</td>
                            <td class="nivel-{{ datos_adc.depresion.general.nivel|lower|replace(' ', '-') }}">{{ datos_adc.depresion.general.nivel }}</td>
                        </tr>
                    </tbody>
                </table>
                {% if datos_adc.depresion.general.interpretacion %}
                <div class="adc-interpretacion">
                    <strong>Interpretación General:</strong> {{ datos_adc.depresion.general.interpretacion }}
                </div>
                {% endif %}
            </div>

            <!-- CONGRUENCIA -->
            <div class="adc-subsection">
                <div class="adc-subsection-title">Escala de Congruencia</div>
                <table class="adc-table">
                    <thead>
                        <tr>
                            <th>Área</th>
                            <th>Valoración (Est.)</th>
                            <th>Nivel Valoración</th>
                            <th>Conducta (Est.)</th>
                            <th>Nivel Conducta</th>
                            <th>Congruencia</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for nombre, datos in datos_adc.congruencia.areas.items() %}
                        <tr>
                            <td style="text-align: left; font-weight: bold;">{{ nombre }}</td>
                            <td>{{ datos.valoracion.estandarizado }}</td>
                            <td class="nivel-{{ datos.valoracion.nivel|lower|replace(' ', '-') }}">{{ datos.valoracion.nivel }}</td>
                            <td>{{ datos.conducta.estandarizado }}</td>
                            <td class="nivel-{{ datos.conducta.nivel|lower|replace(' ', '-') }}">{{ datos.conducta.nivel }}</td>
                            <td class="nivel-{{ datos.congruencia|lower|replace(' ', '-') }}">{{ datos.congruencia }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                {% for nombre, datos in datos_adc.congruencia.areas.items() %}
                {% if datos.valoracion.interpretacion %}
                <div class="adc-interpretacion" style="margin-bottom: 5px;">
                    <strong>{{ nombre }} - Valoración:</strong> {{ datos.valoracion.interpretacion }}
                </div>
                {% endif %}
                {% if datos.conducta.interpretacion %}
                <div class="adc-interpretacion" style="margin-bottom: 5px;">
                    <strong>{{ nombre }} - Conducta:</strong> {{ datos.conducta.interpretacion }}
                </div>
                {% endif %}
                {% endfor %}
            </div>

            {% else %}
                <div class="result-item" style="text-align: center; padding: 40px; background: #fff3cd; border-left: 4px solid #ffc107;">
                    <h3 style="color: #856404;">NO HAY DATOS DISPONIBLES</h3>
                    <p style="color: #856404;">No se encontraron resultados del Perfil Psicológico ADC para este paciente.</p>
                </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- FOOTER -->
        <div class="footer">
            BIENESTAR Y SALUD LABORAL SAS - CALLE 134 NO. 7-83 CONS 233 - BOGOTÁ - www.bsl.com.co - Teléfono + 57 601 580 2318
        </div>
    </div>

</body>
</html>
